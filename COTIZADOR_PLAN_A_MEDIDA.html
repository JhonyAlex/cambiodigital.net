<!-- ============================================================
     COTIZADOR "ARMA TU PLAN A MEDIDA" - CÓDIGO COMPLETO
     Extraído para estudio y desarrollo posterior
     ============================================================ -->

<!-- ============================================================
     SECCIÓN 5.5: TEASER DEL COTIZADOR (EN EL BODY)
     ============================================================ -->
<section 
    id="cotizador-teaser" 
    class="w-full flex flex-col items-center justify-center p-8 py-24 border-t-4 border-b-4 border-black"
    data-bg="bg-cd-lavender"
    data-text="text-black"
    data-shadow="#0f1327"
    data-highlight="#5a82ff"
>
    <div class="max-w-4xl w-full text-center">
        <span class="bg-black text-white px-4 py-1 font-mono text-sm font-bold uppercase mb-6 inline-block shadow-[4px_4px_0_rgba(0,0,0,0.2)]">¿No te sirven los paquetes?</span>
        <h2 class="reveal font-black text-5xl md:text-7xl uppercase mb-8 leading-none">
            Arma tu Plan <br><span class="text-stroke-black text-white">A Medida</span>
        </h2>
        <p class="reveal font-mono text-lg md:text-xl mb-12 max-w-2xl mx-auto">
            Selecciona los módulos exactos que necesitas, añade extras y obtén un presupuesto estimado al instante. Sin compromisos.
        </p>
        
        <button onclick="openQuoteModal()" class="reveal bg-cd-magenta text-white font-bold text-xl md:text-2xl py-6 px-12 border-hard shadow-hard btn-press hover:bg-white hover:text-black uppercase flex items-center justify-center gap-4 mx-auto transition-colors">
            <i data-lucide="calculator" class="w-8 h-8"></i>
            Calcular Mi Precio Ahora
        </button>
    </div>
</section>


<!-- ============================================================
     MODAL DEL COTIZADOR (ANTES DEL CIERRE </body>)
     ============================================================ -->
<div id="quote-modal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-sm overflow-y-auto">
    <div class="min-h-screen w-full flex items-center justify-center p-4 md:p-8">
        <div class="bg-cd-cream w-full max-w-7xl border-4 border-white shadow-[0_0_40px_rgba(194,0,179,0.3)] relative animate-fade-in flex flex-col lg:flex-row overflow-hidden">
            
            <!-- Close Button -->
            <button onclick="closeQuoteModal()" class="absolute top-4 right-4 z-50 bg-black text-white p-2 hover:bg-cd-magenta transition-colors border-2 border-white shadow-lg">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Left Column: Services -->
            <div class="flex-1 p-6 md:p-10 overflow-y-auto max-h-[60vh] lg:max-h-[85vh] bg-gray-50">
                <h3 class="font-black text-3xl uppercase mb-2">Configura tu Solución</h3>
                <p class="font-mono text-sm text-gray-500 mb-8">Selecciona los módulos para ver el precio estimado.</p>
                
                <div class="grid grid-cols-1 gap-6" id="services-grid">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="w-full lg:w-[400px] bg-white border-l-0 lg:border-l-4 border-black p-6 md:p-10 flex flex-col shadow-[-10px_0_20px_rgba(0,0,0,0.1)] z-40 relative">
                <div class="mb-6 border-b-4 border-black pb-4">
                    <h3 class="font-black text-2xl uppercase flex items-center gap-2">
                        <i data-lucide="receipt" class="w-6 h-6"></i> Resumen
                    </h3>
                </div>

                <div id="summary-items" class="flex-1 overflow-y-auto max-h-[200px] space-y-3 mb-6 pr-2 font-mono text-sm empty:hidden">
                    <div class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300">
                        Selecciona servicios
                    </div>
                </div>

                <!-- Totals Block -->
                <div class="bg-cd-purple-dark text-white p-4 border-2 border-black shadow-[4px_4px_0_#0f1327] mb-6">
                    <div class="flex justify-between items-end mb-2 opacity-70 text-xs font-mono">
                        <span>Valor de Mercado</span>
                        <span class="line-through decoration-cd-magenta" id="total-market">$0</span>
                    </div>
                    <div class="h-0.5 bg-white/20 my-2"></div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold uppercase text-sm">Total Único</span>
                        <span class="font-black text-3xl tracking-tighter" id="total-one-time">$0</span>
                    </div>
                    <div class="flex justify-between items-center text-cd-magenta font-bold text-xs" id="row-monthly">
                        <span>+ Mensualidad</span>
                        <span id="total-monthly">$0/mes</span>
                    </div>
                    <div class="mt-3 bg-green-400 text-black text-center py-1 font-black text-xs uppercase border border-black shadow-[2px_2px_0_black]">
                        Ahorras: <span id="total-savings">$0</span>
                    </div>
                </div>

                <!-- Form -->
                <div class="space-y-3 mb-4">
                    <input type="text" id="quote-company" placeholder="Empresa / Negocio" class="w-full p-3 bg-gray-50 border-2 border-black font-mono text-sm focus:outline-none focus:bg-cd-lavender transition-colors">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="quote-name" placeholder="Tu Nombre" class="w-full p-3 bg-gray-50 border-2 border-black font-mono text-sm focus:outline-none focus:bg-cd-lavender transition-colors">
                        <input type="email" id="quote-email" placeholder="Email" class="w-full p-3 bg-gray-50 border-2 border-black font-mono text-sm focus:outline-none focus:bg-cd-lavender transition-colors">
                    </div>
                </div>

                <button onclick="sendQuote()" id="btn-send-quote" class="w-full bg-black text-white font-bold py-4 uppercase border-2 border-transparent hover:bg-cd-magenta hover:border-black transition-all shadow-hard flex items-center justify-center gap-2 group">
                    <i data-lucide="send" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                    Recibir Cotización
                </button>
                <p id="quote-feedback" class="text-center font-mono text-xs mt-2 hidden"></p>
            </div>
        </div>
    </div>
</div>


<!-- ============================================================
     JAVASCRIPT DEL COTIZADOR
     ============================================================ -->
<script>
    // --- COTIZADOR LOGIC ---
    
    // Database
    const SERVICES_DB = [
        {
            id: 'web-essential',
            name: 'Página Esencial',
            description: 'Diseño básico hasta 3 secciones. Ideal para presencia rápida.',
            basePrice: 400,
            marketValue: 650,
            features: ['3 Secciones', 'Optimización Básica', 'Responsive'],
            icon: 'layout',
            extras: [
                { id: 'copy', name: 'Redacción (Copywriting)', price: 50, type: 'one-time' },
                { id: 'form', name: 'Formulario Avanzado', price: 20, type: 'one-time' }
            ]
        },
        {
            id: 'web-custom',
            name: 'Página Personalizada',
            description: 'Diseño a medida con funcionalidades avanzadas y SEO.',
            basePrice: 800,
            marketValue: 1200,
            features: ['Diseño a Medida', 'SEO Técnico', 'Integraciones'],
            icon: 'smartphone',
            extras: [
                { id: 'chatbot-basic', name: 'Integrar Chatbot Básico', price: 150, type: 'one-time' },
                { id: 'sections', name: 'Sección Extra ($40 c/u)', price: 40, type: 'counter' }
            ]
        },
        {
            id: 'store-adv',
            name: 'Tienda Avanzada',
            description: 'Catálogo amplio, pasarelas de pago y diseño personalizado.',
            basePrice: 2400,
            marketValue: 3500,
            features: ['Pasarelas de Pago', 'Catálogo Amplio', 'Panel Admin'],
            icon: 'database',
            extras: [
                { id: 'priority', name: 'Carga Prioritaria', price: 200, type: 'one-time' }
            ]
        },
        {
            id: 'chatbot-ai',
            name: 'Chatbot Esencial',
            description: 'Atención automática para clientes 24/7.',
            basePrice: 180,
            marketValue: 300,
            features: ['Respuestas Rápidas', 'Lógica de Árbol'],
            icon: 'message-square',
            extras: [
                { id: 'ai-token', name: 'Inteligencia Artificial (GPT)', price: 50, type: 'monthly' },
                { id: 'whatsapp', name: 'WhatsApp API Oficial', price: 30, type: 'monthly' }
            ]
        },
        {
            id: 'hosting',
            name: 'Hosting & Dominio',
            description: 'Alojamiento anual seguro y nombre de dominio.',
            basePrice: 260,
            marketValue: 350,
            features: ['SSL Incluido', 'Correos Corporativos', 'Backups'],
            icon: 'shield-check',
            extras: [
                { id: 'storage', name: '50GB Almacenamiento Extra', price: 50, type: 'one-time' }
            ]
        }
    ];

    // State
    let quoteState = {
        selected: {}, 
        extras: {}
    };

    // Modal Functions
    window.openQuoteModal = function() {
        document.getElementById('quote-modal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        document.documentElement.classList.add('overflow-hidden'); // Fix scroll on html
        if(window.lucide) lucide.createIcons();
        
        // Ensure grid is populated
        const grid = document.getElementById('services-grid');
        if(grid && grid.children.length === 0) {
            initQuoteCalculator();
        }
    }

    window.closeQuoteModal = function() {
        document.getElementById('quote-modal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        document.documentElement.classList.remove('overflow-hidden'); // Fix scroll on html
    }

    // Core Functions
    function initQuoteCalculator() {
        console.log('Initializing Quote Calculator...');
        const grid = document.getElementById('services-grid');
        if(!grid) {
            console.error('Services grid not found');
            return;
        }

        grid.innerHTML = SERVICES_DB.map(service => `
            <div class="bg-white border-2 border-black shadow-[4px_4px_0_#ddd] p-6 transition-all duration-300 cursor-pointer group hover:shadow-[6px_6px_0_black] hover:-translate-y-1" 
                 id="card-${service.id}"
                 onclick="toggleService('${service.id}')">
                
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-gray-100 text-black border-2 border-transparent group-hover:border-black group-hover:bg-cd-magenta group-hover:text-white transition-colors">
                        <i data-lucide="${service.icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="text-right">
                        <span class="block text-2xl font-black">$${service.basePrice}</span>
                        <span class="text-xs font-mono uppercase bg-cd-lavender px-1 border border-black">Pago Único</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 mb-2">
                    <div class="w-6 h-6 border-2 border-black flex items-center justify-center bg-white transition-colors" id="check-${service.id}">
                        <i data-lucide="check" class="w-4 h-4 opacity-0 transition-opacity"></i>
                    </div>
                    <h3 class="font-black text-xl uppercase">${service.name}</h3>
                </div>
                
                <p class="font-mono text-sm text-gray-600 mb-4 pl-9">${service.description}</p>
                
                <div class="pl-9 flex flex-wrap gap-2 mb-4">
                    ${service.features.map(f => `<span class="text-xs font-bold border border-black px-2 py-1 bg-gray-50">${f}</span>`).join('')}
                </div>

                <!-- Extras Container -->
                <div id="extras-${service.id}" class="hidden pl-9 pt-4 border-t-2 border-gray-200 mt-4" onclick="event.stopPropagation()">
                    <p class="text-xs font-bold uppercase mb-2 text-cd-purple-medium">Personalizar:</p>
                    <div class="space-y-2">
                        ${service.extras.map(extra => `
                            <div class="flex items-center justify-between bg-white border border-black p-2 shadow-sm">
                                <div class="flex items-center gap-2">
                                    ${extra.type === 'counter' 
                                        ? `<div class="flex items-center gap-1 bg-gray-100 border border-black px-1">
                                             <button onclick="updateExtra('${service.id}', '${extra.id}', -1)" class="hover:text-cd-magenta font-bold px-1">-</button>
                                             <span id="count-${service.id}-${extra.id}" class="font-mono text-sm w-4 text-center">0</span>
                                             <button onclick="updateExtra('${service.id}', '${extra.id}', 1)" class="hover:text-cd-magenta font-bold px-1">+</button>
                                           </div>`
                                        : `<button onclick="toggleExtra('${service.id}', '${extra.id}')" 
                                                   class="w-5 h-5 border-2 border-black flex items-center justify-center hover:bg-gray-100 transition-colors"
                                                   id="btn-extra-${service.id}-${extra.id}">
                                                <i data-lucide="check" class="w-3 h-3 opacity-0"></i>
                                           </button>`
                                    }
                                    <span class="text-xs font-mono font-bold">${extra.name}</span>
                                </div>
                                <span class="text-xs font-bold text-cd-purple-dark">+$${extra.price}${extra.type === 'monthly' ? '/mes' : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `).join('');
        
        if(window.lucide) lucide.createIcons();
    }

    window.toggleService = function(id) {
        console.log('Toggling service:', id);
        const isSelected = !!quoteState.selected[id];
        
        if (isSelected) {
            delete quoteState.selected[id];
            delete quoteState.extras[id];
            
            // UI Updates
            const card = document.getElementById(`card-${id}`);
            if(card) {
                card.classList.remove('ring-4', 'ring-black', 'bg-cd-cream');
                card.classList.add('bg-white');
            }
            
            const check = document.getElementById(`check-${id}`);
            if(check) {
                check.querySelector('i').classList.add('opacity-0');
                check.classList.remove('bg-black', 'text-white');
                check.classList.add('bg-white');
            }
            
            const extras = document.getElementById(`extras-${id}`);
            if(extras) extras.classList.add('hidden');

        } else {
            quoteState.selected[id] = true;
            quoteState.extras[id] = {};
            
            // UI Updates
            const card = document.getElementById(`card-${id}`);
            if(card) {
                card.classList.remove('bg-white');
                card.classList.add('ring-4', 'ring-black', 'bg-cd-cream');
            }
            
            const check = document.getElementById(`check-${id}`);
            if(check) {
                check.querySelector('i').classList.remove('opacity-0');
                check.classList.remove('bg-white');
                check.classList.add('bg-black', 'text-white');
            }
            
            // Show extras if any
            const service = SERVICES_DB.find(s => s.id === id);
            const extras = document.getElementById(`extras-${id}`);
            if(service && service.extras.length > 0 && extras) {
                extras.classList.remove('hidden');
            }
        }
        calculateQuote();
    };

    window.toggleExtra = function(serviceId, extraId) {
        if (!quoteState.extras[serviceId]) quoteState.extras[serviceId] = {};
        const current = quoteState.extras[serviceId][extraId];

        const btn = document.getElementById(`btn-extra-${serviceId}-${extraId}`);
        const icon = btn ? btn.querySelector('i') : null;

        if (current) {
            delete quoteState.extras[serviceId][extraId];
            if(btn) btn.classList.remove('bg-black', 'text-white');
            if(icon) {
                icon.classList.add('opacity-0');
                icon.classList.remove('text-white');
            }
        } else {
            quoteState.extras[serviceId][extraId] = true;
            if(btn) btn.classList.add('bg-black', 'text-white');
            if(icon) {
                icon.classList.remove('opacity-0');
                icon.classList.add('text-white');
            }
        }
        calculateQuote();
    };

    window.updateExtra = function(serviceId, extraId, delta) {
        if (!quoteState.extras[serviceId]) quoteState.extras[serviceId] = {};
        
        const current = quoteState.extras[serviceId][extraId] || 0;
        const newValue = Math.max(0, current + delta);
        
        if (newValue === 0) {
            delete quoteState.extras[serviceId][extraId];
        } else {
            quoteState.extras[serviceId][extraId] = newValue;
        }

        const countEl = document.getElementById(`count-${serviceId}-${extraId}`);
        if(countEl) countEl.innerText = newValue;
        
        calculateQuote();
    };

    function calculateQuote() {
        let oneTime = 0;
        let monthly = 0;
        let market = 0;
        const summaryList = document.getElementById('summary-items');
        if(summaryList) summaryList.innerHTML = '';

        const selectedIds = Object.keys(quoteState.selected);
        
        if (selectedIds.length === 0 && summaryList) {
            summaryList.innerHTML = '<div class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300">Selecciona servicios para comenzar</div>';
        }

        selectedIds.forEach(id => {
            const service = SERVICES_DB.find(s => s.id === id);
            if(!service) return;

            oneTime += service.basePrice;
            market += service.marketValue;

            // Add Service to Summary
            let extrasHtml = '';
            const serviceExtras = quoteState.extras[id] || {};
            
            Object.keys(serviceExtras).forEach(exId => {
                const exDef = service.extras.find(e => e.id === exId);
                if(!exDef) return;

                const val = serviceExtras[exId];
                const multiplier = typeof val === 'number' ? val : 1;
                const cost = exDef.price * multiplier;

                if (exDef.type === 'monthly') {
                    monthly += cost;
                    market += (cost * 12);
                } else {
                    oneTime += cost;
                    market += (cost * 1.3);
                }

                extrasHtml += `
                    <div class="flex justify-between text-xs text-gray-500 pl-2 border-l-2 border-gray-300">
                        <span>+ ${exDef.name} ${typeof val === 'number' ? `(x${val})` : ''}</span>
                        <span>$${cost}${exDef.type === 'monthly' ? '/mes' : ''}</span>
                    </div>
                `;
            });

            if(summaryList) {
                summaryList.innerHTML += `
                    <div class="border-b border-gray-200 pb-2 last:border-0">
                        <div class="flex justify-between font-bold text-black">
                            <span>${service.name}</span>
                            <span>$${service.basePrice}</span>
                        </div>
                        ${extrasHtml ? `<div class="mt-1 space-y-1">${extrasHtml}</div>` : ''}
                    </div>
                `;
            }
        });

        // Update Totals
        const elOneTime = document.getElementById('total-one-time');
        const elMarket = document.getElementById('total-market');
        const elMonthly = document.getElementById('total-monthly');
        const elSavings = document.getElementById('total-savings');
        const rowMonthly = document.getElementById('row-monthly');

        if(elOneTime) elOneTime.innerText = `$${oneTime}`;
        if(elMarket) elMarket.innerText = `$${market}`;
        
        if (monthly > 0) {
            if(rowMonthly) {
                rowMonthly.classList.remove('hidden');
                rowMonthly.classList.add('flex');
            }
            if(elMonthly) elMonthly.innerText = `+$${monthly}/mes`;
        } else {
            if(rowMonthly) {
                rowMonthly.classList.add('hidden');
                rowMonthly.classList.remove('flex');
            }
        }

        const savings = Math.max(0, market - oneTime - (monthly * 12));
        if(elSavings) elSavings.innerText = `$${savings.toFixed(0)}`;
    }

    window.downloadQuoteImage = function() {
        if (typeof html2canvas === 'undefined') {
            console.error('html2canvas not loaded');
            return;
        }
        const element = document.querySelector('#quote-modal .bg-cd-cream');
        html2canvas(element, {
            scale: 2,
            backgroundColor: '#f8f8f0',
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'presupuesto-cambiodigital.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => console.error('Error generating image:', err));
    }

    window.sendQuote = async function() {
        const btn = document.getElementById('btn-send-quote');
        const feedback = document.getElementById('quote-feedback');
        const company = document.getElementById('quote-company').value;
        const name = document.getElementById('quote-name').value;
        const email = document.getElementById('quote-email').value;

        if (!company || !name || !email) {
            feedback.innerText = "Por favor completa todos los campos.";
            feedback.className = "text-center font-mono text-xs mt-2 text-red-600 font-bold";
            feedback.classList.remove('hidden');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> Enviando...';
        if(window.lucide) lucide.createIcons();

        // Prepare Data
        const payload = {
            customer: { company, name, email },
            selection: Object.keys(quoteState.selected).map(id => {
                const s = SERVICES_DB.find(ser => ser.id === id);
                return {
                    service: s.name,
                    basePrice: s.basePrice,
                    extras: quoteState.extras[id]
                };
            }),
            totals: {
                oneTime: document.getElementById('total-one-time').innerText,
                monthly: document.getElementById('total-monthly').innerText,
                market: document.getElementById('total-market').innerText,
                savings: document.getElementById('total-savings').innerText
            }
        };

        try {
            // Send to n8n
            await fetch('https://n8n.cambiodigital.cloud/webhook/c1692d85-8ad6-4977-b484-541c16463d0a', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    formType: 'quote_calculator',
                    ...payload
                })
            });

            feedback.innerText = "¡Cotización enviada! Te contactaremos pronto.";
            feedback.className = "text-center font-mono text-xs mt-2 text-green-600 font-bold";
            feedback.classList.remove('hidden');
            btn.innerHTML = '<i data-lucide="check"></i> Enviado';
            
            // Trigger Image Download
            window.downloadQuoteImage();

            // Reset after 3s
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="send"></i> Recibir Cotización';
                if(window.lucide) lucide.createIcons();
            }, 3000);

        } catch (error) {
            console.error(error);
            feedback.innerText = "Error al enviar. Intenta de nuevo.";
            feedback.className = "text-center font-mono text-xs mt-2 text-red-600 font-bold";
            feedback.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = 'Reintentar';
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', initQuoteCalculator);
</script>


<!-- ============================================================
     NOTAS DE DESARROLLO
     ============================================================
     
     DEPENDENCIAS EXTERNAS REQUERIDAS:
     - Tailwind CSS (CDN)
     - Lucide Icons (CDN)
     - html2canvas (CDN) para exportar imagen del presupuesto
     
     ESTRUCTURA DE DATOS:
     - SERVICES_DB: Array de servicios con precios y extras
     - quoteState: Estado global con servicios seleccionados y extras
     
     FUNCIONES PRINCIPALES:
     - openQuoteModal() / closeQuoteModal(): Abrir/cerrar modal
     - toggleService(id): Seleccionar/deseleccionar servicio
     - toggleExtra(serviceId, extraId): Activar/desactivar extras
     - updateExtra(serviceId, extraId, delta): Incrementar/decrementar extras tipo contador
     - calculateQuote(): Recalcular totales y actualizar UI
     - sendQuote(): Enviar cotización a n8n webhook
     - downloadQuoteImage(): Exportar cotización como imagen PNG
     
     INTEGRACIÓN CON N8N:
     - Webhook: https://n8n.cambiodigital.cloud/webhook/c1692d85-8ad6-4977-b484-541c16463d0a
     - Envía datos de cliente, servicios seleccionados y totales
     
     MEJORAS PENDIENTES:
     - [ ] Validación más robusta de formulario
     - [ ] Guardado de cotización en localStorage
     - [ ] Compartir cotización por URL
     - [ ] Animaciones mejoradas
     - [ ] Modo oscuro
     - [ ] Internacionalización (i18n)
     - [ ] Analytics tracking de interacciones
     - [ ] A/B testing de precios
     
     ============================================================ -->

